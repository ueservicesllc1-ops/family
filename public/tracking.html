<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Rastrea tu paquete Family Express">
    <title>Rastreo de Paquetes - Family Express</title>
    <link rel="stylesheet" href="../styles/styles.css">
    <link rel="icon" href="../images/favicon.png">
    <style>
        .tracking-public {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--spacing-lg);
        }

        .tracking-container {
            max-width: 600px;
            width: 100%;
        }

        .tracking-header {
            text-align: center;
            margin-bottom: var(--spacing-xl);
        }

        .tracking-logo {
            font-size: 4rem;
            margin-bottom: var(--spacing-md);
        }

        .tracking-timeline {
            margin-top: var(--spacing-xl);
        }

        .tracking-event {
            position: relative;
            padding: var(--spacing-lg);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
            padding-left: 3rem;
        }

        .tracking-event::before {
            content: '‚óè';
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            font-size: 1.5rem;
        }

        .tracking-event.delivered::before {
            color: var(--success);
        }

        .tracking-event.in_transit::before {
            color: var(--warning);
        }
    </style>
</head>

<body>
    <div class="tracking-public">
        <div class="tracking-container">
            <div class="tracking-header">
                <div class="tracking-logo">üì¶</div>
                <h1>Family Express</h1>
                <p>Rastreo de Paquetes USA ‚Üí Ecuador</p>
            </div>

            <div class="card">
                <div class="form-group">
                    <label class="form-label">C√≥digo de Rastreo</label>
                    <input type="text" id="tracking-code" class="form-input" placeholder="Ej: FE-20241224-0001"
                        style="text-transform: uppercase;">
                </div>
                <button id="search-btn" class="btn btn-primary" style="width: 100%;">
                    <span id="search-icon">üîç</span>
                    <span id="search-text">Buscar mi Paquete</span>
                </button>
            </div>

            <div id="results-container" class="hidden">
                <!-- Results will be shown here -->
            </div>
        </div>
    </div>

    <script type="module">
        import { db, collection, query, where, getDocs, orderBy } from '../src/config/firebase-config.js';

        const trackingCodeInput = document.getElementById('tracking-code');
        const searchBtn = document.getElementById('search-btn');
        const resultsContainer = document.getElementById('results-container');

        searchBtn.addEventListener('click', searchTracking);
        trackingCodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchTracking();
            }
        });

        async function searchTracking() {
            const trackingCode = trackingCodeInput.value.trim().toUpperCase();

            if (!trackingCode) {
                alert('Por favor ingrese un c√≥digo de rastreo');
                return;
            }

            searchBtn.disabled = true;
            document.getElementById('search-text').textContent = 'Buscando...';
            document.getElementById('search-icon').textContent = '‚è≥';

            try {
                // Search for shipment
                const shipmentsRef = collection(db, 'shipments');
                const q = query(shipmentsRef, where('trackingCode', '==', trackingCode));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    showNotFound(trackingCode);
                    return;
                }

                const shipment = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };

                // Get tracking history
                const historyRef = collection(db, 'tracking_history');
                const historyQuery = query(
                    historyRef,
                    where('trackingCode', '==', trackingCode),
                    orderBy('timestamp', 'desc')
                );
                const historySnapshot = await getDocs(historyQuery);
                const history = [];
                historySnapshot.forEach(doc => {
                    history.push({ id: doc.id, ...doc.data() });
                });

                showResults(shipment, history);
            } catch (error) {
                console.error('Error searching:', error);
                alert('Error al buscar el paquete. Por favor intente nuevamente.');
            } finally {
                searchBtn.disabled = false;
                document.getElementById('search-text').textContent = 'Buscar mi Paquete';
                document.getElementById('search-icon').textContent = 'üîç';
            }
        }

        function showNotFound(trackingCode) {
            resultsContainer.innerHTML = `
        <div class="card mt-3">
          <div class="empty-state">
            <div class="empty-state-icon">‚ùå</div>
            <h3>Paquete no encontrado</h3>
            <p>C√≥digo: ${trackingCode}</p>
            <p style="color: var(--text-muted); font-size: 0.875rem;">
              Verifica que hayas ingresado el c√≥digo correctamente.<br>
              Si el problema persiste, contacta a Family Express.
            </p>
          </div>
        </div>
      `;
            resultsContainer.classList.remove('hidden');
        }

        function showResults(shipment, history) {
            const statusLabels = {
                'pending': 'Pendiente',
                'in_transit': 'En tr√°nsito',
                'delivered': 'Entregado',
                'cancelled': 'Cancelado'
            };

            const statusColors = {
                'pending': 'warning',
                'in_transit': 'primary',
                'delivered': 'success',
                'cancelled': 'danger'
            };

            resultsContainer.innerHTML = `
        <div class="card mt-3">
          <h2>${shipment.trackingCode}</h2>
          <div style="display: flex; gap: 1rem; align-items: center; margin: var(--spacing-md) 0;">
            <span class="badge badge-${statusColors[shipment.status]}" style="font-size: 1rem; padding: 0.5rem 1rem;">
              ${statusLabels[shipment.status] || shipment.status}
            </span>
          </div>
          
          <div style="margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: 1px solid var(--glass-border);">
            <p><strong>Destinatario:</strong> ${shipment.clientName}</p>
            <p><strong>Peso:</strong> ${shipment.weight} libras</p>
            <p><strong>Fecha de env√≠o:</strong> ${formatDate(shipment.createdAt.toDate())}</p>
            ${shipment.deliveredAt ? `<p><strong>Fecha de entrega:</strong> ${formatDate(shipment.deliveredAt.toDate())}</p>` : ''}
          </div>
          
          ${history.length > 0 ? `
            <h3 style="margin-top: var(--spacing-xl); margin-bottom: var(--spacing-md);">Historial de Rastreo</h3>
            <div class="tracking-timeline">
              ${history.map(h => `
                <div class="tracking-event ${h.status}">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-xs);">
                    <strong>${statusLabels[h.status] || h.status}</strong>
                    <span style="color: var(--text-muted); font-size: 0.875rem;">${formatDateTime(h.timestamp.toDate())}</span>
                  </div>
                  ${h.location ? `<p style="color: var(--text-secondary); margin-bottom: var(--spacing-xs);">üìç ${h.location}</p>` : ''}
                  ${h.notes ? `<p style="color: var(--text-muted); font-size: 0.875rem;">${h.notes}</p>` : ''}
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>
        
        <div style="text-align: center; margin-top: var(--spacing-lg); color: var(--text-muted); font-size: 0.875rem;">
          <p>¬øNecesitas ayuda? Contacta a Family Express</p>
        </div>
      `;
            resultsContainer.classList.remove('hidden');
        }

        function formatDate(date) {
            return new Intl.DateTimeFormat('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }).format(date);
        }

        function formatDateTime(date) {
            return new Intl.DateTimeFormat('es-ES', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }).format(date);
        }
    </script>
</body>

</html>